<?Lassoscript// Last modified 6/25/10 by ECL, Landmann InterActive // FUNCTIONALITY// This is a contact form. It is self-posting.// Anti-spam prevention is built-in using the principles outlined by Steve Piercy at LDC 09.// NOTES// Contains a switch called $FormStatus that can be used to quickily set the form to a status of up (working) or down.// If it is set to "Down", nothing will appear.// There are commented-out fields which may be useful in the future (First_Name, etc.)// If spam attempt is detected, it will log the attempt. See the errors log.// CHANGE NOTES// 6/25/10// First implementation.// Debugging// Var:'svDebug' = 'Y';'<!-- frm_contact_popup -->\n';// This is a switch to turn on or off accepting form submissions// Var('FormStatus' = 'Down');Var('FormStatus' = 'Up');// Var('vFirst_Name'=(Action_Param:'First_Name'));// Var('vLast_Name'=(Action_Param:'Last_Name'));Var('vName' = (Action_Param:'Name'));// Var('vAddress' = (Action_Param:'Address'));// Var('vCity' = (Action_Param:'City'));// Var('vState' = (Action_Param:'State'));// Var('vZip' = (Action_Param:'Zip'));// Var('vCountry' = (Action_Param:'Country'));Var('vPhone' = (Action_Param:'Phone'));Var('vMail' = (Action_Param:'Mail'));Var('vComments' = (Action_Param:'Comments'));Var('vProcess' = (Action_Param:'Process'));Var('vError' = (Action_Param:'Error'));Var('vOption' = (Action_Param:'Option'));// Used for redirectsVar('GoTo' = (Action_Param:'GoTo'));// Used to see if the form submission was canceled by clicking "No Thanks"Var('Cancel' = (Action_Param:'Cancel'));// TESTING// $GoTo = 'redirectpage';// Skip this immediately and send to the GoTo page if viewer is a botIf: ((lp_client_isBot) == true);	If($GoTo == '');		Var('URL' = ('http://'+($svDomain)+'/'));	Else;		Var('URL' = ('http://'+($svDomain)+$GoTo));	/If;	If($svDebug == 'Y');		Debug;			('59: URL = '+($URL)+'<br>\n');			('Redirect to <a href="'$URL'">'+($URL)+'</a><br>\n');		/Debug;	Else;		Redirect_URL($URL);		Abort;	/If;/If;// The anti-spam field with decodervar('nospam' = encode_base64(encrypt_blowfish2(date->format('%q'),-seed=$svSalt)));var('despam' = date(decrypt_blowfish2(decode_base64(action_param('nospam')),-seed=$svSalt)));// DEBUGGINGvar('despamTemp1' = (action_param('nospam')));var('despamTemp2' = (decode_base64(action_param('nospam'))));var('despamTemp3' = (decrypt_blowfish2(decode_base64(action_param('nospam')),-seed=$svSalt)));var('despamTemp4' = date(decrypt_blowfish2(decode_base64(action_param('nospam')),-seed=$svSalt)));// Hidden field used as spamtrapvar('yourname' = (action_param('yourname')));Debug;	('action_params = ' + (action_params) + '<br>\n');	('action_param(nospam) = ' + (action_param('nospam')) + '<br>\n');	('vProcess = ' + ($vProcess) + '<br>\n');	('vError = ' + ($vError) + '<br>\n');	('vOption = ' + ($vOption) + '<br>\n');	('vName = ' + ($vName) + '<br>\n');	('vPhone = ' + ($vPhone) + '<br>\n');	('vMail = ' + ($vMail) + '<br>\n');	('vComments = ' + ($vComments) + '<br>\n');	('nospam = ' + ($nospam) + '<br>\n');	('despam = ' + ($despam) + '<br>\n');	('date(decrypt_blowfish2(Decode_Base64(mmVyAk7eIoBLyOsWNqk=)) = ' + date(Decrypt_Blowfish2(Decode_Base64('mmVyAk7eIoBLyOsWNqk='),-seed=$svSalt)) + '<br>\n');	('date(decrypt_blowfish2(Decode_Base64(mmVyAk7ZIohMjtimabQ=)) = ' + date(Decrypt_Blowfish2(Decode_Base64('mmVyAk7ZIohMjtimabQ='),-seed=$svSalt)) + '<br>\n');	('date(decrypt_blowfish2(Decode_Base64(mmVyAk7ZIohMjtmtbrs=)) = ' + date(Decrypt_Blowfish2(Decode_Base64('mmVyAk7ZIohMjtmtbrs='),-seed=$svSalt)) + '<br>\n');	('despamTemp1 = ' + $despamTemp1 + '<br>\n');	('despamTemp2 = ' + $despamTemp2 + '<br>\n');	('despamTemp3 = ' + $despamTemp3 + '<br>\n');	('despamTemp4 = ' + $despamTemp4 + '<br>\n');	('yourname = ' + ($yourname) + '<br>\n');	('Cancel = '+($Cancel)+'<br>\n');	('GoTo = '+($GoTo)+'<br>\n');/Debug;If: $FormStatus == 'Down';	'<!-- Contact form is down -->\n';Else;	// Registrations are up, check to see if form has been processed	If: $vProcess == 'Y';		// DISABLING THIS, as for this client nothing is required		// If Action_Param missing, kick out 1003 Required Information error		/*		If: (Var:'vName') == '' || (Var:'vMail') == '' || (Var:'vPhone') =='';			Var:'vError' = '1003';			Var:'vOption' = 'a required field';			Var:'RedirectURL'=((Response_Filepath)+'?Error='+$vError+'&Option='+$vOption+'&Process=T&Name='+$vName+'&Mail='+$vMail+'&Phone='+$vPhone+'&Comments='+$vComments);			Redirect_URL: $RedirectURL;			Abort;		/If;		// Check e-mail address, if bad output error 1102 "E-mail Format Error"		If: (Valid_Email:($vMail)) == false;			$vError = '1102';			Var:'vOption' = '';			Var:'RedirectURL'=((Response_Filepath)+'?Error='+$vError+'&Option='+$vOption+'&Process=T&Name='+$vName+'&Mail='+$vMail+'&Phone='+$vPhone+'&Comments='+$vComments);			Redirect_URL: $RedirectURL;			Abort;		/If;*/		// Is it a spammer?		If(			// Scan for spammy content			(string(action_params) >> 'Content-Type') ||			(string(action_params) >> '<!--') ||			(string(action_params) >> '<script') ||			(string(action_params) >> '[url') ||			(string(action_params) >> '<a') ||			// detect for presence of automated bot			// check "yourname" hidden field			($yourname != '') || 			// minimum number of seconds			(date_difference(date,$despam,-second) < 2) ||			// maximum number of seconds			(date_difference(date,$despam,-second) > 300) 			&& (action_param('nospam') != '')			);			// Do stuff in response to spammer			// Modify html reply, send email, logging, etc.			Log_Critical(($svDomain)+(' -- Form spam stopped from Contact form. Submit by IP ')+(Client_IP));			$vError = '9001';			$vOption = 'Your abuse of this form has been logged and will be reported.';Var('RedirectURL'=((Response_Filepath)+'?Error='+$vError+'&Option='+$vOption+'&Process=N&Name='+$vName+'&Mail='+$vMail+'&Phone='+$vPhone+'&Comments='+$vComments));			// Send e-mail to devel about spam detection			Email_Send:				-Host=$svSMTP,				-From=$svAdminEmail,				-To=$svDeveloperEmail,				-Subject=('Contact Popup Form - SPAM DETECTED'),				-Username=$svAuthUsername,				-Password=$svAuthPassword,				-ReplyTo=$vMail,				-Sender=(($svDomain)+':frm_contact_popup'),				-Body=(Include:'/site/libs/email_contact.txt');			Redirect_URL: $RedirectURL;			Abort;		/If;		// optional - Not currently used		// Adding a Record/*		Inline: -Add, -Database=$svSiteDatabase, -Table=,			'First_Name'=(Var:'vFirst_Name'),			'Last_Name'=(Var:'vLast_Name'),			'Name'=(Var:'vName'),			'Address'=(Var:'vAddress'),			'City'=(Var:'vCity'),			'State'=(Var:'vState'),			'Zip'=(Var:'vZip'),			'Country'=(Var:'vCountry'),			'Phone'=(Var:'vPhone'),			'Mail'=(Var:'vMail'),			'Mod_Date'=(Date_Format:(Date_GetCurrentDate),-DateFormat='%Q'),			'Comments'=(Var:'vComments');*/		Debug;			'Error_CurrentError = ' + (Error_CurrentError) '<br>\n';		/Debug;		// Looking for blank form submission. If everything is blank, don't send e-mails.		If: (Var:'vName') == '' || (Var:'vMail') == '' || (Var:'vPhone') =='';		// Form is not blank		Else;				// Sending the E-mails			Var('From' = $svAdminEmail);			Var('Subject' = 'Contact Form');			Var('Copy' = $svAdminEmail);						// Trap bad e-mail address			If(Valid_Email($vMail) == false);				Email_Send:					-Host=$svSMTP,					-From=$svAdminEmail,					-To=$svAdminEmail,					-Subject=(($Subject)+' (Invalid E-mail Submit)'),					-Username=$svAuthUsername,					-Password=$svAuthPassword,					-ReplyTo=$vMail,					-Sender=(($svDomain)+':frm_contact_popup'),					-Body=(Include:'/site/libs/email_contact.txt');			// E-mail address is valid			Else;							// Send e-mails				If($svDebug == 'Y');					Email_Send:						-Host=$svSMTP,						-From=$vMail,						-To=$svDeveloperEmail,						-Subject=(($Subject)+' DEBUG ON'),						-Username=$svAuthUsername,						-Password=$svAuthPassword,						-ReplyTo=$vMail,						-Sender=(($svDomain)+':frm_contact_popup'),						-Body=(Include:'/site/libs/email_contact.txt');				Else;					Email_Send:						-Host=$svSMTP,						-From=$vMail,						-To=$svAdminEmail,						-Subject=$Subject,						-Username=$svAuthUsername,						-Password=$svAuthPassword,						-ReplyTo=$vMail,						-Sender=(($svDomain)+':frm_contact_popup'),						-Body=(Include:'/site/libs/email_contact.txt');				/If;			/If;					// If no errors, output error 3001 "E-mail sent"			If: (Error_CurrentError) == (Error_NoError);				$vError = '3001';				$vOption = '';			// Otherwise there were errors, output the error			Else;				$vError = '3002';				$vOption = (Error_CurrentError);			/If;		/If; // Look for blank form// /Inline;'<div>\n';'<!-- 168 Stock Error Table Code-->\n';If($vError != '');	LI_ShowError3: -ErrNum=$vError, -Option=$vOption;/If;// Capture the GoTo address. If it is blank, redirect to the home page, otherwise use $GoTo.If($GoTo == '');	Var('URL' = ('http://'+($svDomain)+'/'));Else;	Var('URL' = ('http://'+($svDomain)+$GoTo));/If;If: $svDebug == 'Y';	Debug;		('201: URL = '+($URL)+'<br>\n');		('Redirect to <a href="'$URL'">'+($URL)+'</a><br>\n');	/Debug;Else;	Redirect_URL($URL);/If;// DEVEL NOTE: Thie below comment will not be seen as the Redirect (above) will trigger first.// We are leaving this in place in case you want to get rid of the redirect and see something display.('<p>Your request has been sent to <a href="mailto:'+($svAdminEmail)+'">'+($svAdminEmail)+'</a>. We will be contacting you very soon.</p>\n');// Form not processed yet or has errors, so display the formElse;?><div><h3>Please Contact Me</h3><p>Fill out the brief form below if you would like to be contacted.</p>[If: $vError != '9001' || $vError != '1003' || $vError != '1102']	<!-- Optional comment -->[/If]<?LassoScript'<!-- 188 Stock Error Table Code-->\n';If:($vError != '');	LI_ShowError3: -ErrNum=$vError, -Option=$vOption;/If;?><form action="[Response_Filepath]" method="post" class="contactform"><table class="contactform">[Output_None]	<tr> 		<td colspan="2">        <div align="left"><b><font color="#FF0000">NOTE: </font> Items marked with [$svInputRequired] are required.</b></div></td>	</tr><!--	<tr>         <td width="120">           <div align="right"><b>First Name</b>[$svInputRequired]</div>        </td>        <td width="450" valign="top"> 			<input type="text" name="First_Name" value="[$vFirst_Name]" size="39">        </td>	</tr>	<tr>         <td width="120">           <div align="right"><b>Last Name</b>[$svInputRequired]</div>        </td>        <td width="450" valign="top">	        <input type="text" name="Last_Name" value="[$vLast_Name]" size="39">        </td>	</tr>-->[/Output_None]	<tr>         <td width="120">           <div align="right"><b>Name</b>[Output_None][$svInputRequired][/Output_None]</div>        </td>        <td width="450" valign="top"> 			<input type="text" name="Name" value="[$vName]" size="39">        </td>	</tr>	<tr>         <td width="120">           <div align="right"><b>Email</b>[Output_None][$svInputRequired][/Output_None]</div>        </td>        <td width="450" valign="top">         <input type="text" name="Mail" value="[$vMail]" size="39">        </td>	</tr>[Output_None]<!-- 	<tr>         <td width="120">           <div align="right"><b>Address</b>[$svInputRequired]</div>        </td>        <td width="450" valign="top"> 	        <input type="text" name="Address" value="[$vAddress]" size="39">        </td>	</tr>	<tr>         <td width="120">           <div align="right"><b>City</b>[$svInputRequired]</div>        </td>        <td width="450" valign="top"> 	        <input type="text" name="City" value="[$vCity]" size="39">        </td>	</tr>	<tr>         <td width="120">           <div align="right"><b>State/Province</b>[$svInputRequired]</div>        </td>        <td width="450" valign="top">         <input type="text" name="State" value="[$vState]" size="20">        </td>	</tr>	<tr>         <td width="120">           <div align="right"><b>Zip/Postal Code</b>[$svInputRequired]</div>        </td>        <td width="450" valign="top"> 	        <input type="text" name="Zip" value="[$vZip]" size="18">        </td>	</tr>	<tr>         <td width="120">           <div align="right"><b>Country</b>[$svInputRequired]</div>        </td>        <td width="450" valign="top"> 			<select name="Country">				<option VALUE=""[If($vCountry =='')] selected[/If]></option>				<option value="USA"[If($vCountry =='USA')] selected[/If]>USA</option>				<option VALUE="Canada"[If($vCountry =='Canada')] selected[/If]>Canada</option>				<option VALUE="Other"[If($vCountry =='Other')] selected[/If]>Other</option>			</select>        </td>	</tr>     -->[/Output_None] 	<tr>        <td width="120">           <div align="right"><b>Phone</b>[Output_None][$svInputRequired][/Output_None]</div>        </td>        <td width="450" valign="top"> 	        <input type="text" name="Phone" value="[$vPhone]" size="16">        </td>	</tr>	<tr>         <td width="120">           <div align="right"><b>Comments</b></div>        </td>        <td width="450" valign="top"> 			<textarea name="Comments" cols="50" rows="4">[$vComments]</textarea>        </td>	</tr>	<tr>         <td colspan="2"> 			<div align="center">			<span style="display:none;visibility:hidden;">				<label for="yourname">[Output_None]Ignore this text box. It is used to detect spammers. If you enter anything into this text box, your message will not be sent.[/Output_None]</label>				<input type="text" name="yourname" size="1" value="" id="yourname">			</span>				<input type="submit" name="-Nothing" value="Submit">				<input type="submit" name="Cancel" value="No Thanks">				<input name="nospam" type="hidden" value="[$nospam]">				<input type="hidden" name="GoTo" value="[$GoTo]">				<input type="hidden" name="Process" value="Y">			</div>		</td>	</tr></table></form>[/If][/If]</div>